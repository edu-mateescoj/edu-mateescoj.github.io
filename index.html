<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Exerciseur Python</title>
    <style>
        .exercise-container {
            margin: auto;
            width: 50%;
            border: 1px solid #ddd;
            padding: 20px;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
        }
        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Assure l'espacement entre les éléments */
            margin-bottom: 10px;
        }
        .range-container {
            display: flex;
            align-items: center;
            width: 100%;
        }input[type="text"], input[type="range"] {
            padding: 10px;
            margin-right: 5px; /* Spacing between input and checkbox */
            flex: 1; /* Permet aux inputs de prendre toute la largeur disponible */
        }
        input[type="range"] {
            -webkit-appearance: none; /* Override default CSS styles */
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd; /* Initial background */
            outline: none;
            transition: background 0.3s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
        }

        input[type="checkbox"] {
            margin-right: 5px;
        }
        button {
            padding: 15px 10px;
            margin-right: 5px;
            border: none;
            cursor: pointer;
        }
        .button-new-exercise {
            padding: 10px;
            background-color: #007BFF; /* Blue for new exercise */
            color: white;
        }

        .button-verify {
            /* padding: 10px;*/
            background-color: #28a745; /* Green for verify */
            color: white;
        }

        .button-show-answers {
            padding: 10px;
            background-color: #6c757d; /* Gray for show answers */
            color: white;
        }

        button:hover {
            opacity: 0.7;
        }
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px; /* Espacement en dessous du bloc de code */
        }
        label {
            padding: 10px;
            flex: 0 0 20%; /* Alloue 20% de la largeur du conteneur aux labels */
            margin-right: 10px;
        }
        #variableCount {
            padding: 10px;
            min-width: 40px; /* faut une largeur suffisante pour le chiffre */
            text-align: center;
        }    </style>
    <link rel="icon" href="C:\Users\julien\Downloads\favicon.ico" type="image/x-icon">

    </style>
    <link rel="icon" href="\favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="exercise-container">
        <h2>Exercices automatiques d'assignation de variables</h2>
        <p>Que valent les variables à la fin de l'exécution du code `Python` ci-dessous ?</p>
        <label for="numVariables">Niveau de difficulté (1 à 6):</label>
        <input type="range" id="numVariables" min="1" max="6" value="3" oninput="handleRangeChange(this.value);">
        <span id="variableCount">3</span>
        
        <pre id="code-display">Exemple de code</pre>

        <button id="verify-button" class="button-verify">Vérifier</button>
        <button id="show-button" class="button-show-answers">Montrer les réponses</button>
        <button id="generate-button" class="button-new-exercise">Nouvel exercice</button>
    </div>
    <script>
    const variableNamesWithTypes = {
        anglais: {
            n: "integer", x: "integer", y: "integer", z: "integer", a: "integer", b: "integer", temp:"integer", item: "float",  
            i:"integer", j:"integer", k: "integer", age: "integer", name: "string", user_id: "integer", count: "integer",
            total: "float", sum: "float", product: "float", average: "float", mon_index: "integer", my_index: "integer", index: "integer", 
            max: "float", min: "float", height: "float", width: "float", dividende: "integer", girth: "float", 
            length: "float", size: "integer", position: "integer", status: "string", diviseur: "integer", 
            color: "string", date: "string", flag: "boolean", is_active: "boolean", divisor: "integer", nb_users: "integer", 
            has_items: "boolean", is_visible: "boolean",  nom: "string", user_score: "integer", nb_steps: "integer", 
            score_utilisateur: "integer", compteur: "integer", total_count: "float", speed: "float", nb_msgs: "integer", 
            somme: "float", produit: "float", moyenne: "float", maximum: "float", quotient: "float",
            minimum: "float", hauteur: "float", largeur: "float", longueur: "float", taille: "integer",
            position: "integer", statut: "string", couleur: "string", date: "string", data_points: "float",
            drapeau: "boolean", est_actif: "boolean", a_des_objets: "boolean", est_visible: "boolean",
            est_complet: "boolean", est_valide: "boolean", login_attempts: "integer", 
            cell_number: "integer", is_verified: "boolean", price_per_unit: "float"
                },
        operators: {
            cocktail: ["+", "-", "+", "*", "//", "%","==", "!=", "<", ">", "<=", ">="],
            logique: ["and", "or", "not"],
            comparaison: ["==", "!=", "<", ">", "<=", ">="],
            arithmetique: ["+", "-", "*", "//", "%"]
        }
    };

    let numVariables = 3; //niveau de difficulté par défaut... historiquement c'était le nombre de variables
        
    /* 1) écouteur d'événements attaché à l'objet "document" pour exécuter 
    un appel groupé aux fonctions SEULEMENT APRES QUE le DOM de la page a été chargé 
    (évite bugs liés à l'exécution de scripts qui manipulent le DOM trop tôt
    2) Connecte les clics sur les boutons aux fonctions concernées (x3)
    3) Chaque fois que le curseur est déplacé, la fonction handleRangeChange est appelée avec la nouvelle valeur.
    chatGPT dit: "Ajoute un gestionnaire pour l'événement input sur un élément input de type range identifié par numVariables."
    */
    document.addEventListener('DOMContentLoaded', function() {
     document.getElementById('generate-button').addEventListener('click', generateDynamicExercise);
    document.getElementById('verify-button').addEventListener('click', verifyAnswers);
    document.getElementById('show-button').addEventListener('click', showAnswers);
    document.getElementById('numVariables').addEventListener('input', function() {
        handleRangeChange(this.value);
        });
    generateDynamicExercise(); // appelle  de suite la fonction principale
    });
        
// affectation de la valeur du curseur à la variable
function updateVariableCount(value) {
    document.getElementById('variableCount').textContent = value;
    numVariables = parseInt(value);
}
        
// une bête interpolation linéaire du vert (facile) au rouge (dur)
function updateRangeColor(value) {
    const range = document.getElementById('numVariables');
    const max = parseInt(range.max);
    const min = parseInt(range.min);
    const fraction = (value - min) / (max - min);
    const red = Math.round(250 * fraction);
    const green = Math.round(250 * (1 - fraction));
    const blue = 50;
    range.style.background = `linear-gradient(to right, rgb(${red}, ${green}, ${blue}) ${fraction * 100}%, #ddd ${fraction * 100}%)`;
}

/* à chaque saisie d'un niveau de difficulté, il faut:
1) màj la valeur du niveau de difficulté dans "numVariables"
2) màj la couleur du curseur selon niveau
3) màj la liste des opérateurs selon niveau
4) générer le nouvel exo correspondant 
*/
function handleRangeChange(value) {
    updateVariableCount(value);
    updateRangeColor(value);
    updateOperatorAvailability(value);
    generateDynamicExercise();
}
    // 3) màj la liste des opérateurs selon niveau
    function updateOperatorAvailability(num) {
    const maxOperators = 2*parseInt(num);  
    /* numVariables de 1 à 6; nb_maxOperators de 2 à 12... donc slice[#0;#12[ dans ma liste d'opérateurs, 
    structure de données collée en haut du script: un dictionnaire des opérateurs au format 
    { nom_de_liste : ["operateur1", "operateur2", etc.] }
    NB: historiquement les listes ont changé... longueur variable pour accomoder choix des collègues
    */
    const cocktailOperators = variableNamesWithTypes.operators.cocktail.slice(0, Math.min(maxOperators, variableNamesWithTypes.operators.cocktail.length));
    variableNamesWithTypes.currentOperators = cocktailOperators; 
    console.log('Available Operators:', variableNamesWithTypes.currentOperators); // Debugging
}
 
    // voilà le vif du sujet!!
    function generateDynamicExercise() {
        // nettoyer l'interface utilisateur des anciennes entrées avant de générer de nouvelles
        const container = document.querySelector('.exercise-container');
        const display = document.getElementById('code-display');
        container.querySelectorAll('.input-group').forEach(el => el.remove());

        const variableNames = Object.keys(variableNamesWithTypes.anglais);
        let selectedVariables = []; //une liste pour vérifier si le nom choisi random était déjà là
        let variables = {};         //va recevoir les variables avec leur valeur
        let expressions = [];       //les expressions affichables, selon syntaxe Python
        currentCorrectAnswers = {};  // portée plus large... pour les vérifs!

        /* Initialisation de la liste des variables choisies :
        nom pris parmi liste, puis attribution de valeur random par appel de "initializeVariable"
        boolean: ou 0 ou 1 (50% chance), avec changement syntaxique JS => Python
        integer: entre 0 et 10 ; float et string IDEM ici
        */
        while (selectedVariables.length < numVariables) {
            const randomIndex = Math.floor(Math.random() * variableNames.length);
            const variable = variableNames[randomIndex];
            if (!selectedVariables.includes(variable)) {
                selectedVariables.push(variable);
                variables[variable] = initializeVariable(variableNamesWithTypes.anglais[variable]);
                expressions.push(`${variable} = ${formatValueForDisplay(variables[variable])}`);
            }
        }
        //prise en cpompte niveau de difficulté
        updateOperatorAvailability(numVariables);

        /* Generation des expressions selon types des variables:
        Parcourir la liste des variables choisies, nom "variable" affichable, à la position "index"
        1) préparer les éléments HTML - CSS
        2) créer une expression logique ou arithmétique selon type de variable
        3) évaluer l'expression pour obtenir la valeur finale de la variable
        4) stocker l'expression et la valeur finale dans les listes appropriées
        5) mélanger les expressions pour éviter une corrélation entre les variables
        6) afficher les expressions dans l'élément "pre" de la page
        7) stocker les réponses correctes dans un objet pour la vérification
        8) afficher les éléments d'entrée de texte et les cases à cocher pour l'utilisateur
        */
        selectedVariables.forEach((variable, index) => {
            // 1)
            //des identifiants uniques pour les éléments d'entrée de texte et les cases à cocher
            const inputId = `inputValue${index + 1}`;
            const errorCheckboxId = `errorCheckbox${index + 1}`;
            //nouveau "div" créé pour chaque variable, conteneur pour les éléments de saisie (texte, étiquettes, cases à cocher)
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';

            //création d'une "étiquette" qui sera à gauche de l'élément d'entrée de texte
            const labelElement = document.createElement('label');
            labelElement.htmlFor = inputId;
            labelElement.textContent = `${variable}:`;
            
            // création des éléments d'entrée de réponse pour l'élève + étiquette "Erreur?"
            const inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.id = inputId;
            inputElement.placeholder = `Valeur finale de ${variable}`;
            const errorCheckbox = document.createElement('input');
            errorCheckbox.type = 'checkbox';
            errorCheckbox.id = errorCheckboxId;
            const errorLabel = document.createElement('label');
            errorLabel.htmlFor = errorCheckboxId;
            errorLabel.textContent = "Erreur ?";
            
            //assemblage des éléments
            inputGroup.appendChild(labelElement);
            inputGroup.appendChild(inputElement);
            inputGroup.appendChild(errorCheckbox);
            inputGroup.appendChild(errorLabel);
            //ajout au conteneur principal
            container.appendChild(inputGroup);

            /* étapes 2) et 3)
            2)
            Génération des expressions: le type de la variable (booléenne ou non) définit l'ensemble des opérateurs parmi lesquels choisir
            si booléenne, on prend l'opérateur aléatoirement dans la liste assocée à la clé "logique", sinon parmi le "cocktail" adapté au niveau
            3)
            Evaluation de l'expression pour obtenir la valeur finale de la variable
            */
            const isBoolean = variableNamesWithTypes.anglais[variable] === "boolean";
            const operatorSet = isBoolean ? variableNamesWithTypes.operators.logique : variableNamesWithTypes.currentOperators;
            const operator = operatorSet[Math.floor(Math.random() * operatorSet.length)];
            let otherVariable, expression, evalResult;
 
            if (isBoolean && operator === "not") {
                expression = `${variable} = not ${variable}`;
                evalResult = !variables[variable];
            } else {
                otherVariable = selectAppropriateVariable(selectedVariables, variables, variable, isBoolean);
                const valueToUse = otherVariable ? variables[otherVariable] : getRandomBoolean();
                expression = `${variable} = ${variable} ${operator} ${formatValueForDisplay(valueToUse)}`;
                evalResult = evaluateExpression(variables[variable], valueToUse, operator);
            }
            // étape 4)
            // Stockage des expressions et des valeurs dans les listes appropriées
            expressions.push(expression);
            // étape 7)
            // Stockage des réponses correctes dans un objet pour la vérification
            variables[variable] = evalResult;
            currentCorrectAnswers[inputId] = typeof evalResult === 'boolean' ? formatValueForDisplay(evalResult) : evalResult.toString();
        });
        //  5)
        // Mélange des expressions (après les assignations initiales) pour ajouter de l'aléatoire à l'affichage
        shuffle(expressions, numVariables);
        
        // 7)
        display.textContent = expressions.join('\n');
    }

    // pour étape 5)
    // fonction utilitaire: mélanger un tableau à partir d'une position donnée
    function shuffle(array, start) {
        for (let i = array.length - 1; i > start-1; i--) {
            const j = start + Math.floor(Math.random() * (i+1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // fonction utilitaire: initialiser aléatoirement, selon type, une variable
    function initializeVariable(type) {
        switch(type) {
            case "integer":
            case "float": //on fait semblant... on veut pas de calcul avec décimales!
            case "string": //on verra plus tard pour les op sur string
                return Math.floor(Math.random() * 11) - 0;
            case "boolean":
                return Math.random() < 0.5;
            default:
                return null; // just in case... débuggage
        }
    }
    // fonction utilitaire: ne fait que rajouter la majuscule (JS => Python) pour les booléens
    function formatValueForDisplay(value) {
        if (typeof value === 'boolean') {
            return value ? "True" : "False";
        }
        return value;
    }
    /* fonction utilitaire: sélectionne une variable appropriée pour former une expression logique ou sinon arithmétique
    a) On commence par filtrer le tableau "variables" pour exclure la "currentVariable" de la sélection, 
    b) Deuxième critère de filtrage : le type de la valeur associée à chaque variable dans l'objet "values"
        Si booléen: l'opération doit être logique, et donc seule une autre variable de type boolean ('boolean') peut être choisie. 
        Sinon: l'opération est arithmétique ou de comparaison, et une variable de type numérique ('number') est nécessaire.
    c) Sélection de la première correspondance :
        Après le filtrage, le tableau résultant contient toutes les variables qui ne sont pas la variable actuelle et qui ont le type approprié pour l'opération en cours. 
        La fonction retourne le premier élément de ce tableau filtré avec indexation [0].
        Si aucune variable n'est disponible qui correspond aux critères (par exemple, s'il n'y a pas d'autres variables booléennes pour une opération logique), 
        cette fonction retournerait undefined... à gérer par le code appelant.
    */
    function selectAppropriateVariable(variables, values, currentVariable, isBoolean) {
        return variables.filter(v => v !== currentVariable && typeof values[v] === (isBoolean ? 'boolean' : 'number'))[0];
    }
    // pour étape 3)
    function getRandomBoolean() {
        return Math.random() < 0.5;
    }
    // plus utilisée pour l'instant... mais on sait jamais :)
    function getRandomCompar() {
        return Math.floor(Math.random() *  variableNamesWithTypes.operators.comparaison.length);
    }
    // pour étape 3)
    function evaluateExpression(left, right, operator) {
        try {
            switch(operator) {
            case "and":
                return left && right;
            case "or":
                return left || right;
            case "not":
                return !left; // opérateur unaire... donc devrait être géré ailleurs
            case "+":
            case "-":
            case "*":
                return eval(`${left} ${operator} ${right}`);
            case "//":
                if (right === 0) return "Error: Division by zero";
                return Math.floor(left / right);
            case "%":
                if (right === 0) return "Error: Division by zero";
                return left % right;
            default:
                return eval(`${left} ${operator} ${right}`);
        }
        } catch (e) {
            console.error('oups... (pas vu, pas pris):', e.message);
            return "Error: Invalid expression";
        
        }
    }

    function verifyAnswers() {
    document.querySelectorAll('.input-group').forEach(group => {
        const input = group.querySelector('input[type="text"]');
        const errorCheckbox = group.querySelector('input[type="checkbox"]');
        const userAnswer = input.value.trim();
        const correctAnswer = currentCorrectAnswers[input.id];
        
        if (errorCheckbox.checked){
            if (correctAnswer === "Error: Division by zero" && userAnswer === "") {
                input.style.backgroundColor = 'lightgreen';  // Correctly predicted error
            } else if (correctAnswer === "Error: Division by zero") {   //aurait pas dû rentrer valeur
                input.style.backgroundColor = '';  // contradiction enter checkBox et valeur
            } else {
                input.style.backgroundColor = 'salmon';  // Incorrect answer or error not predicted
            }}
            else {
                if (userAnswer === "") {
                    input.style.backgroundColor = "";
                } else if (userAnswer === correctAnswer) {
                    input.style.backgroundColor = 'lightgreen';  // Correct answer
                } else {
                    input.style.backgroundColor = 'salmon';  // Incorrect answer
                }
            }
        });
    }
    function showAnswers() {
        document.querySelectorAll('.input-group').forEach(group => {
            const input = group.querySelector('input[type="text"]');
            const errorCheckbox = group.querySelector('input[type="checkbox"]');
            if (currentCorrectAnswers[input.id].startsWith("Error")) {
                errorCheckbox.checked = true;
                input.value = "";  // Clear the input as it's an error
                input.style.backgroundColor = 'lightgray';
            } else {
                input.value = currentCorrectAnswers[input.id];
                input.style.backgroundColor = 'lightgray';
            }
        });
    }
    </script>
</body>
</html>
